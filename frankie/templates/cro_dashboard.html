<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Frankie AI – CRO Dashboard</title>
  <style>

    /* Base reset + body styles to match other dashboards */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    background: #f5f5f5;
    color: #333333;
    line-height: 1.6;
    }

    /* Card look parity */
    .card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    /* Minimal layout styles so CRO matches other dashboards */
    .sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;z-index:100}
    .sidebar-header{padding:20px;border-bottom:1px solid #f0f0f0}
    .brand-logo{display:flex;align-items:center;gap:12px;font-size:18px;font-weight:600;color:#1a1a1a}
    .sidebar-nav{flex:1;padding:20px 0}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 20px;color:#666;text-decoration:none;font-size:14px;transition:.2s;position:relative}
    .nav-item:hover{background:#f8f9fa;color:#333}
    .nav-item.active{background:#f0f4ff;color:#667eea;font-weight:500}
    .nav-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:#667eea}
    .sidebar-footer{padding:20px;border-top:1px solid #f0f0f0}
    .date-range-info{display:flex;flex-direction:column;gap:8px}
  
    .main-content{margin-left:240px;min-height:100vh;background:#f5f5f5}
    .main-container{max-width:1400px;margin:0 auto;padding:30px}
  
    /* Page-level bits */
    .page-title{font-size:24px;font-weight:700;color:#1a1a1a;margin-bottom:6px}
    .subtle{font-size:12px;color:#888}
    .card{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:18px}
    .grid{display:grid;gap:20px}
    .grid-2{grid-template-columns:1fr 1fr}
    .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .pill-btn{border:1px solid #e0e0e0;background:#fff;border-radius:9999px;padding:8px 12px;font-size:12px;cursor:pointer}
    .pill-btn:hover{background:#f8f9fa}
    .ai-box{background:#faf8ff;border:1px solid #e7e2ff;border-radius:8px}
    .ai-title{font-size:14px;font-weight:600;color:#333;margin-bottom:10px}
    .ai-text{font-size:14px;color:#444;line-height:1.6;white-space:pre-line}
    .chart-box{height:320px}

    /* Frankie widget */
    .frankie-launcher {
    position: fixed; right: 20px; bottom: 20px;
    background: #3b82f6; /* blue */
    color: #fff; border: 0; border-radius: 9999px;
    padding: 10px 14px; font-size: 14px; font-weight: 600;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    cursor: pointer; z-index: 9998;
    display: inline-flex; align-items: center; gap: 8px;
    }
    .frankie-launcher:hover { filter: brightness(1.05); }

    .frankie-panel {
    display: flex;               /* ability to scroll within Frankie */
    flex-direction: column;      /* ability to scroll within frankkie */
    position: fixed; right: 20px; bottom: 76px;
    width: 450px; max-height: min(70vh, 520px);
    background: #fff; border: 1px solid #e5e7eb; border-radius: 12px;
    box-shadow: 0 24px 48px rgba(0,0,0,.18);
    max-height: 70vh; 
    overflow: hidden; z-index: 9999; display: none;
    }

    .frankie-panel.open { display: flex; flex-direction: column; }

    .frankie-panel-header {
    display:flex; align-items:center; justify-content: space-between;
    padding: 12px 14px; border-bottom: 1px solid #f1f5f9; background:#f8fafc;
    }
    .frankie-title { font-size: 14px; font-weight: 700; color:#111827; }
    .frankie-close {
    border:0; background:transparent; cursor:pointer; font-size:18px; color:#6b7280;
    }
    .frankie-body {
    flex: 1 1 auto;
    padding: 18px 28px 28px;     /* smaller top padding, more balanced sides */
    font-size: var(--frankie-text-size, 14px);
    line-height: 1.6;
    color:#374151;
    overflow: auto;              /* enable scrolling inside */
    -webkit-overflow-scrolling: touch; /* smooth on iOS */
    }
    .frankie-body .muted { color:#6b7280; }

    @media (max-width: 520px){
    .frankie-panel{ right:10px; left:10px; width:auto; bottom:72px; }
    .frankie-launcher{ right:10px; bottom:10px; }
    }

    /* Re-use one size for header + in-body headings */
    :root {
        --frankie-title-size: 20px;   /* match the widget header text size */
        --frankie-text-size: 14px;
    }

    /* Panel container polish */
    .frankie-panel {
        max-width: 640px;            /* a bit wider so bullets don’t wrap too fast */
        border-radius: 12px;
        max-width: 90vw;
    }

    /* Header uses the shared title size */
    .frankie-header .title {
        font-size: var(--frankie-title-size);
        font-weight: 700;
        letter-spacing: -0.01em;
    }

    /* Body spacing + readable lists */
    .frankie-content {
        padding: 20px 24px 26px;     /* give the content its own padding */
        font-size: var(--frankie-text-size);
        line-height: 1.55;
    }

    /* Make the AI section headings match the header size */
    .frankie-content h3 {
        font-size: 18px; 
        font-weight: 700;
        margin: 14px 0 8px;          /* space above/below headings */
        color: #1a1a1a;
    }

    /* Lists: proper indent + breathing room between bullets */
    .frankie-content ul {
        margin: 0 0 10px 1.1rem;     /* left indent for bullets */
        padding: 0;
    }
    .frankie-content li {
        margin: 6px 0;               /* vertical spacing between bullets */
    }

    /* Subtle muted helper text style (fallbacks, etc.) */
    .frankie-content .muted { color:#6b7280; }

    /* Frankie popup body spacing */
    .frankie-body {
    padding: 28px 32px 32px;   /* already decent inner padding */
    font-size: var(--frankie-text-size, 14px);
    line-height: 1.6;
    color:#374151;
    }

    /* Section headings */
    .frankie-body h3 {
    font-size: 18px;
    font-weight: 700;
    margin: 10px 0 8px;       
    color:#1a1a1a;
    }

    /* Frankie Lists */
    .frankie-body ul {
    margin: 0 0 14px 1.5rem;
    padding: 0;
    }
    .frankie-body li {
    margin: 6px 0;
    line-height: 1.55;
    }

    .frankie-body p {
    margin: 0 0 14px;
    }

  </style>
</head>
<body>

    {% include '_sidebar.html' %}

  <div class="main-content">
    <div class="main-container">

      <div class="header-row">
        <div>
          <div class="page-title">CRO Dashboard</div>
        </div>
        <div>
            <a href="/merchandise?from={{ date_from }}&to={{ date_to }}&refresh=1"
            style="font-size:12px; color:#667eea; text-decoration:none; border:1px solid #e0e0e0; padding:6px 10px; border-radius:14px;">
           Refresh data
         </a>
        </div>
      </div>

      <!-- Overall Purchase Conversion (full width) -->
<div class="card" style="margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin:0;">Overall Purchase Conversion Rate</h3>
    </div>
    <div style="position:relative;height:320px;">
      <canvas id="overallCvrChart"></canvas>
    </div>
    <div id="overallCvrEmpty" style="display:none;padding:10px 0;color:#888;font-size:13px;">
      No overall CVR data in the selected range.
    </div>
  </div>
  
  <!-- 2-column row: Desktop (left) + Mobile (right) -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
    <!-- Desktop -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin:0;">Desktop Purchase Conversion Rate</h3>
      </div>
      <div style="position:relative;height:280px;">
        <canvas id="desktopCvrChart"></canvas>
      </div>
      <div id="desktopCvrEmpty" style="display:none;padding:10px 0;color:#888;font-size:13px;">
        No desktop CVR data in the selected range.
      </div>
    </div>
  
    <!-- Mobile -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin:0;">Mobile Purchase Conversion Rate</h3>
      </div>
      <div style="position:relative;height:280px;">
        <canvas id="mobileCvrChart"></canvas>
      </div>
      <div id="mobileCvrEmpty" style="display:none;padding:10px 0;color:#888;font-size:13px;">
        No mobile CVR data in the selected range.
      </div>
    </div>
  </div>
  <!-- 2-column row: Add-to-Cart (left) + Begin Checkout (right) -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
    <!-- Add to Cart -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin:0;">Add to Cart Rate</h3>
      </div>
      <div style="position:relative;height:280px;">
        <canvas id="atcChart"></canvas>
      </div>
      <div id="atcEmpty" style="display:none;padding:10px 0;color:#888;font-size:13px;">
        No add-to-cart data in the selected range.
      </div>
    </div>
  
    <!-- Begin Checkout -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="font-size:16px;font-weight:600;color:#1a1a1a;margin:0;">Begin Checkout Rate</h3>
      </div>
      <div style="position:relative;height:280px;">
        <canvas id="bcChart"></canvas>
      </div>
      <div id="bcEmpty" style="display:none;padding:10px 0;color:#888;font-size:13px;">
        No begin-checkout data in the selected range.
      </div>
    </div>
  </div>

<!-- Ask Frankie floating widget -->
<button class="frankie-launcher" id="frankieLauncher" aria-controls="frankiePanel" aria-expanded="false">
    <!-- simple icon -->
    <span aria-hidden="true">✨</span> Ask Frankie
  </button>
  
  <div class="frankie-panel" id="frankiePanel" role="dialog" aria-labelledby="frankieTitle" aria-modal="false">
    <div class="frankie-panel-header">
      <div class="frankie-title" id="frankieTitle">AI Summary of Conversion Movements</div>
      <button class="frankie-close" id="frankieClose" aria-label="Close">×</button>
    </div>
    <div class="frankie-body" id="frankieContent">
      <div class="muted">Loading summary…</div>
    </div>
  </div>

  <script>
    (function(){
      const launcher = document.getElementById('frankieLauncher');
      const panel    = document.getElementById('frankiePanel');
      const closeBtn = document.getElementById('frankieClose');
      const content  = document.getElementById('frankieContent');
    
      async function fetchAiHtml(){
        try{
          const r = await fetch("{{ helpers.url('api_ask_frankie_cro') if helpers else '/api/ask-frankie/cro' }}");
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json();
          if (j && j.ok && j.html) return j.html;
          throw new Error(j && j.error ? j.error : "No HTML returned");
        }catch(e){
          // Fallback to previous lightweight client-side summary
          console.warn("Ask Frankie AI failed; using local summary.", e);
          const src = document.getElementById('aiSummary');
          if (src && src.innerHTML.trim()) return src.innerHTML;
    
          try {
            const L = (window.TS && Array.isArray(TS.labels)) ? TS.labels : [];
            const V = (window.TS && Array.isArray(TS.purchase_cvr)) ? TS.purchase_cvr : [];
            if (!L.length || !V.length) return '<span class="muted">No data for the selected period.</span>';
            const first = Number(V[0]), last = Number(V[V.length-1]), delta = last-first;
            const sign = delta >= 0 ? '↑' : '↓';
            return [
              '<h3>Overview</h3><ul>',
              `<li>Site purchase rate ended at ${last.toFixed(2)}% (${sign} ${Math.abs(delta).toFixed(2)} pts vs start).</li>`,
              '</ul><h3>Insights</h3><ul>',
              ((TS.add_to_cart_rate||[]).length ? `<li>Add-to-Cart latest: ${Number(TS.add_to_cart_rate.at(-1)).toFixed(2)}%.</li>` : ''),
              ((TS.begin_checkout_rate||[]).length ? `<li>Begin-Checkout latest: ${Number(TS.begin_checkout_rate.at(-1)).toFixed(2)}%.</li>` : ''),
              '</ul><h3>Recommendations</h3><ul>',
              '<li>Focus on mobile form friction and payment reliability if device gap persists.</li>',
              '</ul>'
            ].join('');
          } catch { return '<span class="muted">Summary unavailable.</span>'; }
        }
      }
    
      async function openPanel(){
        panel.classList.add('open');
        launcher.setAttribute('aria-expanded','true');
        content.innerHTML = '<div class="muted">AI Scanning conversion rate data...</div>';
        content.innerHTML = await fetchAiHtml();
        localStorage.setItem('frankie_open','1');
      }
      function closePanel(){
        panel.classList.remove('open');
        launcher.setAttribute('aria-expanded','false');
        localStorage.setItem('frankie_open','0');
      }
      function togglePanel(){ panel.classList.contains('open') ? closePanel() : openPanel(); }
    
      launcher.addEventListener('click', togglePanel);
      closeBtn.addEventListener('click', closePanel);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePanel(); });
    
      if (localStorage.getItem('frankie_open') === '1') openPanel();
    })();
    </script>
<script>
    // Backend data
    window.CRO_DATA = {{ cro_data | tojson | safe }};
    const TS = {{ ts | tojson | safe }};
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Make both objects truly global
    window.CRO_DATA = {{ cro_data | tojson | safe }};
    window.TS       = {{ ts | tojson | safe }};
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
  (function () {
    const CRO = window.CRO_DATA || {};
    const overall = (CRO.overall && CRO.overall.daily) || { labels: [], values: [] };
    const desktop = (CRO.desktop && CRO.desktop.daily) || { labels: [], values: [] };
    const mobile  = (CRO.mobile  && CRO.mobile.daily)  || { labels: [], values: [] };
  
    // ✅ Fallback to TS when overall not present in CRO_DATA
    if ((!overall.labels.length || !overall.values.length) &&
        window.TS && Array.isArray(window.TS.labels) && Array.isArray(window.TS.purchase_cvr)) {
      overall.labels = window.TS.labels.slice();
      overall.values = window.TS.purchase_cvr.slice();
    }
  
    // Light debug so you can see what's happening
    console.group("CRO Overall Debug");
    console.log("overall.labels", overall.labels);
    console.log("overall.values", overall.values);
    console.log("TS present?", !!window.TS);
    console.groupEnd();
  
    function mkPercentChart(canvasId, datasetLabel, labels, values, emptyId) {
      const canvas = document.getElementById(canvasId);
      const empty  = document.getElementById(emptyId);
      if (!canvas) return;
  
      if (!labels.length || !values.length) {
        if (empty) empty.style.display = 'block';
        console.warn(`No data for ${datasetLabel}`, { labels, values });
        return;
      } else if (empty) {
        empty.style.display = 'none';
      }
  
      const cleanVals = values.map(Number).filter(Number.isFinite);
      new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels, datasets: [{ label: datasetLabel, data: cleanVals, tension: 0.3, fill: false, pointRadius: 2, borderWidth: 2 }] },
        options: {
          responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: v => v + '%' }, title: { display: true, text: 'Conversion Rate (%)' } },
            x: { ticks: { autoSkip: true, maxTicksLimit: 14 } }
          }
        }
      });
    }
  
    mkPercentChart('overallCvrChart', 'Site-wide Purchase CVR (%)', overall.labels, overall.values, 'overallCvrEmpty');
    mkPercentChart('desktopCvrChart', 'Desktop Purchase CVR (%)',   desktop.labels, desktop.values, 'desktopCvrEmpty');
    mkPercentChart('mobileCvrChart',  'Mobile Purchase CVR (%)',    mobile.labels,  mobile.values,  'mobileCvrEmpty');
    // ATC + Begin Checkout from TS (site-wide daily rates)
    const tsLabels = (window.TS && Array.isArray(TS.labels)) ? TS.labels : [];
    const atcVals  = (window.TS && Array.isArray(TS.add_to_cart_rate)) ? TS.add_to_cart_rate : [];
    const bcVals   = (window.TS && Array.isArray(TS.begin_checkout_rate)) ? TS.begin_checkout_rate : [];

    mkPercentChart('atcChart', 'Add to Cart Rate (%)', tsLabels, atcVals, 'atcEmpty');
    mkPercentChart('bcChart',  'Begin Checkout Rate (%)', tsLabels, bcVals, 'bcEmpty');

    // AI summary uses the same 'overall' now
    (function populateAISummary(){
      const el = document.getElementById('aiSummary');
      if (!el) return;
      const vals = overall.values || [];
      if (!vals.length) { el.textContent = 'No data available for the selected period.'; return; }
      const first = Number(vals[0]), last = Number(vals.at(-1)), delta = last - first, sign = delta >= 0 ? '↑' : '↓';
      const parts = [
        `• Site-wide purchase conversion rate ended at ${last.toFixed(2)}% (${sign} ${Math.abs(delta).toFixed(2)} pts vs. period start).`
      ];
      if (window.TS?.add_to_cart_rate?.length) parts.push(`• Add-to-Cart rate latest: ${Number(window.TS.add_to_cart_rate.at(-1)).toFixed(2)}%`);
      if (window.TS?.begin_checkout_rate?.length) parts.push(`• Begin-Checkout rate latest: ${Number(window.TS.begin_checkout_rate.at(-1)).toFixed(2)}%`);
      el.innerHTML = ['<strong>Site-wide conversion rate</strong>', parts.join('<br>')].join('<br>');
    })();
  })();
  </script>
<script>
    window.FRANKIE = {
      title: "AI Summary of Conversion Movements",
      page: "cro",
      window: { from: "{{ date_from }}", to: "{{ date_to }}" },
      // Keep only what the model needs — small but meaningful
      payload: {
        ts: {{ ts | tojson | safe }},                 // sitewide + device CVRs + ATC/Checkout
        desktop: {{ cro_data.get('desktop', {}) | tojson | safe }},
        mobile:  {{ cro_data.get('mobile', {})  | tojson | safe }}
      },
      // Optional: starter HTML so panel isn’t empty on first open
      summaryHTML: document.getElementById('aiSummary')?.innerHTML || null
    };
  </script>
  {% include '_frankie.html' %}
</body>
</html>