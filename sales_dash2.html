<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333333;
            line-height: 1.6;
        }

        /* Loading spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #667eea;
            z-index: 9999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar with Filters */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .brand-logo {
            font-size: 20px;
            font-weight: 600;
        }

        /* Filter sections */
        .filters-container {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
        }

        /* Restore the original filter section styling */
        .filter-section {
            border-bottom: 1px solid #f0f0f0;
            padding: 0;
        }

        .filter-section-header {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            transition: background 0.2s;
        }

        .filter-section-header:hover {
            background: #f5f5f5;
        }

        .filter-section-header::after {
            content: '▼';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .filter-section.collapsed .filter-section-header::after {
            transform: rotate(-90deg);
        }

        .filter-options {
            padding: 10px 20px;
            max-height: 300px;
            overflow-y: auto;
            display: block;  /* Show by default */
        }

        .filter-section.collapsed .filter-options {
            display: none;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 6px 0;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            transition: color 0.2s;
        }

        .filter-option:hover {
            color: #667eea;
        }

        .filter-checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Filter controls */
        .filter-controls {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn-apply {
            background: #667eea;
            color: white;
        }

        .filter-btn-apply:hover {
            background: #5a6fd8;
        }

        .filter-btn-clear {
            background: white;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .filter-btn-clear:hover {
            background: #f5f5f5;
        }

        /* Active filter count badge */
        .filter-count {
            display: inline-block;
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* Main content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            background: #f5f5f5;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Top Navigation */
        .top-nav {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 40px 0 20px 40px;  /* More top padding and left padding */
        margin-bottom: 30px;
        margin-left: -30px;
        margin-right: -30px;
        margin-top: -30px;
        display: flex;
        gap: 20px;  /* More gap between items */
        }

        .nav-item {
            padding: 10px 20px;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -1px;
        }

        .nav-item:hover {
            color: #333;
            background: rgba(102, 126, 234, 0.05);  /* Added subtle hover background */
            border-radius: 6px 6px 0 0;
        }

        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px 6px 0 0;
        }

        .title-section {
            margin-bottom: 30px;
        }

        .main-title {
            font-size: 28px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 15px;
            color: #666666;
        }

        /* Active filters display */
        .active-filters-bar {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: none;
        }

        .active-filters-bar.show {
            display: block;
        }

        .active-filters-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .active-filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #f0f4ff;
            border: 1px solid #667eea30;
            border-radius: 12px;
            font-size: 12px;
            color: #667eea;
        }

        .filter-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .filter-tag-remove:hover {
            opacity: 1;
        }

        /* Stats and other existing styles... */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #888888;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .chart-subtitle {
            font-size: 11px;
            color: #888;
            margin-bottom: 15px;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .chart-container-small {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .chart-container-large {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #888;
            background: #fafafa;
            border-bottom: 2px solid #e0e0e0;
        }

        .data-table td {
            padding: 12px;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            display: inline-block;
        }

        .badge-red {
            background-color: #ffebee;
            color: #c62828;
        }

        .badge-orange {
            background-color: #fff3e0;
            color: #e65100;
        }

        .badge-green {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-gray {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        /* Sales Coach Styles */
        .insight-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .insight-content {
            font-size: 14px;
            line-height: 1.8;
            color: #555;
        }

        .insight-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .insight-content li {
            margin: 8px 0;
        }

        .insight-highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        /* Gradient background for scorecard */
        .gradient-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Responsive grid adjustment */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr !important;
            }
        }
        .coach-metric {
            display: inline-block;
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 4px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div>Loading dashboard data...</div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" style="display: none;">
        <!-- Sidebar with Filters -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="brand-logo">Sales AI Dashboard</div>
            </div>
            
            <div class="filters-container">
                <!-- Lead Topics Filter -->
            <div class="filter-section collapsed" id="filter-section-topics">
                <div class="filter-section-header" onclick="toggleFilterSection('topics')">
                    Lead Topics
                    <span class="filter-count" id="count-topics" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-topics">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Months Filter -->
            <div class="filter-section collapsed" id="filter-section-months">
                <div class="filter-section-header" onclick="toggleFilterSection('months')">
                    Months
                    <span class="filter-count" id="count-months" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-months">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Products Filter -->
            <div class="filter-section collapsed" id="filter-section-products">
                <div class="filter-section-header" onclick="toggleFilterSection('products')">
                    Products
                    <span class="filter-count" id="count-products" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-products">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Agents Filter -->
            <div class="filter-section collapsed" id="filter-section-agents">
                <div class="filter-section-header" onclick="toggleFilterSection('agents')">
                    Agents
                    <span class="filter-count" id="count-agents" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-agents">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Lead Outcomes Filter -->
            <div class="filter-section collapsed" id="filter-section-outcomes">
                <div class="filter-section-header" onclick="toggleFilterSection('outcomes')">
                    Lead Outcomes
                    <span class="filter-count" id="count-outcomes" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-outcomes">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Wrap Up Reasons Filter -->
            <div class="filter-section collapsed" id="filter-section-wrapup">
                <div class="filter-section-header" onclick="toggleFilterSection('wrapup')">
                    Wrap Up Reasons
                    <span class="filter-count" id="count-wrapup" style="display: none;">0</span>
                </div>
                <div class="filter-options" id="filter-options-wrapup">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            </div>

            <div class="filter-controls">
                <button class="filter-btn filter-btn-apply" onclick="applyFilters()">Apply</button>
                <button class="filter-btn filter-btn-clear" onclick="clearAllFilters()">Clear All</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="nav-item active" onclick="showTab('overview')">Overview</div>
                <div class="nav-item" onclick="showTab('content')">Call Content</div>
                <div class="nav-item" onclick="showTab('performance')">Sales Performance</div>
                <div class="nav-item" onclick="showTab('risks')">Risks & Objections</div>
                <div class="nav-item" onclick="showTab('coach')">Sales Coach (Beta)</div>
            </div>

            <div class="main-container">
                <!-- Active Filters Bar -->
                <div class="active-filters-bar" id="activeFiltersBar">
                    <div class="active-filters-label">Active Filters:</div>
                    <div class="active-filter-tags" id="activeFilterTags">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" id="statsGrid">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Overview Tab (renamed from Quality) -->
                <div id="overview-tab" class="tab-content active">
                    <div class="title-section">
                        <h1 class="main-title">Sales Calls Overview</h1>
                        <p class="subtitle">Monitor and manage key sales call metrics</p>
                    </div>
                    
                    <!-- Overview Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Sales Calls</div>
                            <div class="stat-number" id="stat-total-calls">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average Sentiment</div>
                            <div class="stat-number" id="stat-avg-sentiment">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average Opportunity</div>
                            <div class="stat-number" id="stat-avg-opportunity">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Completion Rate</div>
                            <div class="stat-number" id="stat-completion-rate">0%</div>
                        </div>
                    </div>
                    
                    <!-- Quality charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">Average Opportunity Score Over Time</div>
                            <div class="chart-container-small">
                                <canvas id="opportunityChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Average Sentiment Over Time</div>
                            <div class="chart-container-small">
                                <canvas id="sentimentChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Customer Engagement Score</div>
                            <div class="chart-container-small">
                                <canvas id="engagementChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Tab -->
                <div id="content-tab" class="tab-content">
                    <div class="title-section">
                        <h1 class="main-title">Content Analysis</h1>
                        <p class="subtitle">Understand what customers are asking and topics being discussed</p>
                    </div>
                    
                    <!-- Content Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Questions Asked</div>
                            <div class="stat-number" id="stat-total-questions">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Top Question Category</div>
                            <div class="stat-number" id="stat-top-question" style="font-size: 18px;">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Most Discussed Topic</div>
                            <div class="stat-number" id="stat-top-topic" style="font-size: 18px;">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Unique Topics</div>
                            <div class="stat-number" id="stat-unique-topics">0</div>
                        </div>
                    </div>
                    
                    <!-- Content charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">Most Common Question Types</div>
                            <div class="chart-subtitle">Customer question categories</div>
                            <div class="chart-container-large">
                                <canvas id="questionsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Most Common Topics Discussed</div>
                            <div class="chart-subtitle">Key topics in conversations</div>
                            <div class="chart-container-large">
                                <canvas id="topicsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Tab -->
                <div id="performance-tab" class="tab-content">
                    <div class="title-section">
                        <h1 class="main-title">Sales Performance</h1>
                        <p class="subtitle">Track sales objectives, tactics, and performance metrics</p>
                    </div>
                    
                    <!-- Performance Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Objectives Achieved</div>
                            <div class="stat-number" id="stat-objectives-yes">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average Performance</div>
                            <div class="stat-number" id="stat-avg-performance">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Most Used Tactic</div>
                            <div class="stat-number" id="stat-top-tactic" style="font-size: 16px;">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-number" id="stat-success-rate">0%</div>
                        </div>
                    </div>
                    
                    <!-- Performance charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">Sales Tactics Being Used</div>
                            <div class="chart-container">
                                <canvas id="tacticsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Call Objectives Achieved</div>
                            <div class="chart-container">
                                <canvas id="objectivesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card" style="margin-top: 20px;">
                        <div class="chart-title">Sales Performance Score Over Time</div>
                        <div class="chart-container-small">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Risks Tab -->
                <div id="risks-tab" class="tab-content">
                    <div class="title-section">
                        <h1 class="main-title">Risks & Objections</h1>
                        <p class="subtitle">Identify and manage sales risks and customer objections</p>
                    </div>
                    
                    <!-- First row: Risk Factors (full width) -->
                    <div class="chart-card" style="margin-bottom: 20px;">
                        <div class="chart-title">Risk Factors Identified</div>
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Second row: Objections and Objection Handling Score -->
                    <div class="charts-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 20px;">
                        <div class="chart-card">
                            <div class="chart-title">Most Common Objections</div>
                            <div class="chart-container">
                                <canvas id="objectionsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Avg. Objection Handling Score</div>
                            <div style="display: flex; align-items: center; justify-content: center; height: 250px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; font-weight: 600; color: #667eea;" id="objectionHandlingScore">-</div>
                                    <div style="font-size: 14px; color: #666; margin-top: 10px;">Out of 100</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Third row: Wrap-up Reasons and Accuracy Scorecard -->
                    <div class="charts-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 20px;">
                        <div class="chart-card">
                            <div class="chart-title">Wrap-up Reasons Distribution</div>
                            <div class="chart-container">
                                <canvas id="wrapUpReasonsChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="chart-title" style="color: white;">Wrap-up Accuracy Rate</div>
                            <div style="display: flex; align-items: center; justify-content: center; height: 250px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 64px; font-weight: 700; color: white;" id="wrapUpAccuracyRate">-</div>
                                    <div style="font-size: 16px; color: rgba(255,255,255,0.9); margin-top: 10px;">Accurate + Somewhat Accurate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table" style="margin-top: 30px;">
                        <div style="padding: 15px 20px; border-bottom: 1px solid #e0e0e0; background: #fafafa;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin: 0;">Wrap-up Accuracy Details</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Lead ID</th>
                                    <th>Call Name</th>
                                    <th>Wrap-up Accuracy</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="wrapupTableBody">
                                <!-- Will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Sales Coach Tab -->
                <div id="coach-tab" class="tab-content">
                    <div class="title-section">
                        <h1 class="main-title">AI Sales Coach</h1>
                        <p class="subtitle">AI-driven insights to improve sales performance</p>
                    </div>
                    
                    <!-- Coach Controls -->
                    <div class="coach-controls" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="font-size: 12px; color: #666; font-weight: 600; display: block; margin-bottom: 5px; text-transform: uppercase;">Analysis Scope</label>
                                <select id="coachScope" onchange="updateCoachAnalysis()" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                                    <option value="all">All Agents</option>
                                    <option value="agent">Specific Agent</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px; display: none;" id="agentSelectContainer">
                                <label style="font-size: 12px; color: #666; font-weight: 600; display: block; margin-bottom: 5px; text-transform: uppercase;">Select Agent</label>
                                <select id="agentSelect" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 14px;">
                                    <option value="">Select an agent...</option>
                                </select>
                            </div>
                            <div style="flex: 0;">
                                <button onclick="generateCoachReport()" class="filter-btn filter-btn-apply" style="margin-top: 23px; padding: 10px 30px;">
                                    Generate Analysis
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="coachLoading" style="display: none; text-align: center; padding: 60px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="color: #666; margin-top: 20px;">Analyzing sales data and generating insights...</p>
                    </div>

                    <!-- Coach Insights Container -->
                    <div id="coachInsights" style="display: none;">
                        <!-- Success Patterns -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #22c55e;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">Success Patterns</h3>
                            <div id="successPatterns" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>

                        <!-- Failure Patterns -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #ef4444; margin-top: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">Areas for Improvement</h3>
                            <div id="failurePatterns" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>

                        <!-- Behavioral Insights -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #667eea; margin-top: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">Behavioral Insights</h3>
                            <div id="behavioralInsights" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>

                        <!-- A/B Test Suggestions -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #f59e0b; margin-top: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">Suggested A/B Tests</h3>
                            <div id="abTests" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>

                        <!-- AI Academy -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #10b981; margin-top: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">AI Academy - New Tracking Suggestions</h3>
                            <div id="aiAcademy" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>

                        <!-- Objection Master -->
                        <div class="chart-card" style="background: #fafafa; border-left: 4px solid #dc2626; margin-top: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px;">Objection Master</h3>
                            <div id="objectionMaster" style="font-size: 14px; line-height: 1.8; color: #555;">
                                <!-- Will be populated by AI -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Loading State -->
        <div id="coachLoading" style="display: none; text-align: center; padding: 40px;">
            <div class="spinner"></div>
            <p style="color: #666; margin-top: 20px;">Analyzing sales data and generating insights...</p>
        </div>

        <!-- Coach Insights -->
        <div id="coachInsights" style="display: none;">
            <!-- Success Patterns -->
            <div class="insight-card" style="background: #f0f9ff; border-left: 4px solid #22c55e;">
                <h3 class="insight-title">📈 Success Patterns</h3>
                <div class="insight-content" id="successPatterns">
                    <!-- Will be populated by AI -->
                </div>
            </div>

            <!-- Failure Patterns -->
            <div class="insight-card" style="background: #fff5f5; border-left: 4px solid #ef4444;">
                <h3 class="insight-title">⚠️ Areas for Improvement</h3>
                <div class="insight-content" id="failurePatterns">
                    <!-- Will be populated by AI -->
                </div>
            </div>

            <!-- Behavioral Insights -->
            <div class="insight-card" style="background: #f5f3ff; border-left: 4px solid #667eea;">
                <h3 class="insight-title">🎯 Behavioral Insights</h3>
                <div class="insight-content" id="behavioralInsights">
                    <!-- Will be populated by AI -->
                </div>
            </div>

            <!-- A/B Test Suggestions -->
            <div class="insight-card" style="background: #fffbeb; border-left: 4px solid #f59e0b;">
                <h3 class="insight-title">🔬 Suggested A/B Tests</h3>
                <div class="insight-content" id="abTests">
                    <!-- Will be populated by AI -->
                </div>
            </div>

            <!-- AI Academy -->
            <div class="insight-card" style="background: #f0fdf4; border-left: 4px solid #10b981;">
                <h3 class="insight-title">🎓 AI Academy - New Tracking Suggestions</h3>
                <div class="insight-content" id="aiAcademy">
                    <!-- Will be populated by AI -->
                </div>
            </div>

            <!-- Objection Master -->
            <div class="insight-card" style="background: #fef2f2; border-left: 4px solid #dc2626;">
                <h3 class="insight-title">🛡️ Objection Master</h3>
                <div class="insight-content" id="objectionMaster">
                    <!-- Will be populated by AI -->
                </div>
            </div>
        </div>
    </div>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js datalabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        let dashboardData = null;
        let charts = {};
        let activeFilters = {
            lead_topics: [],
            months: [],
            products: [],
            agents: [],
            lead_outcomes: [],
            wrap_up_reasons: []
        };

        // Initialize dashboard
    async function initDashboard() {
        try {
            const params = buildFilterParams();
            const response = await fetch(`http://localhost:5001/api/dashboard-data?${params}`);
            dashboardData = await response.json();
            
            // Populate filters on first load only
            if (!document.querySelector('.filter-option')) {
                populateFilters();
                // Collapse all filter sections initially
                document.querySelectorAll('.filter-section').forEach(section => {
                    section.classList.add('collapsed');
                });
            }
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
            
            updateStats();
            initializeCharts();
            updateActiveFiltersDisplay();
            
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Update the showTab function to populate agents AFTER checking dashboardData exists
    function showTab(tabName) {
        // Update nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Map the nav names to tab IDs
        let tabId;
        switch(tabName) {
            case 'overview':
                tabId = 'overview-tab';
                break;
            case 'content':
                tabId = 'content-tab';
                break;
            case 'performance':
                tabId = 'performance-tab';
                break;
            case 'risks':
                tabId = 'risks-tab';
                break;
            case 'coach':
                tabId = 'coach-tab';
                // Only populate if dashboardData exists
                if (dashboardData && dashboardData.filter_options) {
                    populateAgentSelect();
                }
                break;
        }
        
        const tabEl = document.getElementById(tabId);
        if (tabEl) {
            tabEl.classList.add('active');
            // Re-render charts when switching tabs to ensure they display
            setTimeout(() => {
                if (charts && Object.keys(charts).length > 0) {
                    Object.values(charts).forEach(chart => {
                        if (chart) chart.update();
                    });
                }
            }, 100);
        }
    }

    // Update the populateAgentSelect function with better error handling
    function populateAgentSelect() {
        const select = document.getElementById('agentSelect');
        if (!select) {
            console.log('Agent select element not found');
            return;
        }
        
        if (!dashboardData || !dashboardData.filter_options || !dashboardData.filter_options.agents) {
            console.log('No agent data available');
            select.innerHTML = '<option value="">No agents available</option>';
            return;
        }
        
        select.innerHTML = '<option value="">Select an agent...</option>';
        
        dashboardData.filter_options.agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = agent;
            select.appendChild(option);
        });
        
        console.log('Populated', dashboardData.filter_options.agents.length, 'agents');
    }

    function populateAgentSelect() {
        const select = document.getElementById('agentSelect');
        if (!select) {
            console.error('Agent select element not found');
            return;
        }
        
        // Clear current options
        select.innerHTML = '<option value="">Select an agent...</option>';
        
        if (!dashboardData || !dashboardData.filter_options || !dashboardData.filter_options.agents) {
            console.error('No agent data available:', dashboardData);
            select.innerHTML = '<option value="">No agents available - load data first</option>';
            return;
        }
        
        // Add each agent as an option
        dashboardData.filter_options.agents.forEach(agent => {
            if (agent) {  // Make sure agent is not empty
                const option = document.createElement('option');
                option.value = agent;
                option.textContent = agent;
                select.appendChild(option);
            }
        });
        
        console.log(`Populated ${dashboardData.filter_options.agents.length} agents`);
        console.log('Dashboard data:', dashboardData);
        console.log('Filter options:', dashboardData?.filter_options);
        console.log('Agents:', dashboardData?.filter_options?.agents)
    }

    // Filter toggle
    function toggleFilterSection(section) {
        console.log('Toggling section:', section);
        const sectionEl = document.getElementById(`filter-section-${section}`);
        console.log('Section element found:', sectionEl);
        
        if (sectionEl) {
            const wasCollapsed = sectionEl.classList.contains('collapsed');
            console.log('Was collapsed:', wasCollapsed);
            sectionEl.classList.toggle('collapsed');
            console.log('Is now collapsed:', sectionEl.classList.contains('collapsed'));
        }
    }

            function populateFilters() {
                const options = dashboardData.filter_options;
                
                // Lead Topics
                const topicsContainer = document.getElementById('filter-options-topics');
                topicsContainer.innerHTML = '';
                options.lead_topics.forEach(topic => {
                    topicsContainer.innerHTML += createFilterOption('topics', topic, topic);
                });
                
                // Months
                const monthsContainer = document.getElementById('filter-options-months');
                monthsContainer.innerHTML = '';
                options.months.forEach(month => {
                    const date = new Date(month + '-01');
                    const label = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    monthsContainer.innerHTML += createFilterOption('months', month, label);
                });
                
                // Products
                const productsContainer = document.getElementById('filter-options-products');
                productsContainer.innerHTML = '';
                options.products.forEach(product => {
                    productsContainer.innerHTML += createFilterOption('products', product, product);
                });
                
                // Agents
                const agentsContainer = document.getElementById('filter-options-agents');
                agentsContainer.innerHTML = '';
                options.agents.forEach(agent => {
                    agentsContainer.innerHTML += createFilterOption('agents', agent, agent);
                });
                
                // Lead Outcomes
                const outcomesContainer = document.getElementById('filter-options-outcomes');
                outcomesContainer.innerHTML = '';
                options.lead_outcomes.forEach(outcome => {
                    outcomesContainer.innerHTML += createFilterOption('outcomes', outcome, outcome);
                });
                
                // Wrap Up Reasons
                const wrapupContainer = document.getElementById('filter-options-wrapup');
                wrapupContainer.innerHTML = '';
                options.wrap_up_reasons.forEach(reason => {
                    wrapupContainer.innerHTML += createFilterOption('wrapup', reason, reason);
                });
            }

            function createFilterOption(category, value, label) {
                return `
                    <label class="filter-option">
                        <input type="checkbox" 
                            class="filter-checkbox" 
                            data-category="${category}" 
                            value="${value}"
                            onchange="updateFilterCount('${category}')">
                        <span>${label}</span>
                    </label>
                `;
            }

            function updateFilterCount(category) {
                const checkboxes = document.querySelectorAll(`[data-category="${category}"]:checked`);
                const countEl = document.getElementById(`count-${category}`);
                
                if (checkboxes.length > 0) {
                    countEl.textContent = checkboxes.length;
                    countEl.style.display = 'inline-block';
                } else {
                    countEl.style.display = 'none';
                }
            }

            function buildFilterParams() {
                const params = new URLSearchParams();
                
                // Get all checked filters
                const checkedFilters = {
                    lead_topic: Array.from(document.querySelectorAll('[data-category="topics"]:checked')).map(cb => cb.value),
                    month: Array.from(document.querySelectorAll('[data-category="months"]:checked')).map(cb => cb.value),
                    product: Array.from(document.querySelectorAll('[data-category="products"]:checked')).map(cb => cb.value),
                    agent: Array.from(document.querySelectorAll('[data-category="agents"]:checked')).map(cb => cb.value),
                    lead_outcome: Array.from(document.querySelectorAll('[data-category="outcomes"]:checked')).map(cb => cb.value),
                    wrap_up_reason: Array.from(document.querySelectorAll('[data-category="wrapup"]:checked')).map(cb => cb.value)
                };
                
                // Add to params
                for (const [key, values] of Object.entries(checkedFilters)) {
                    values.forEach(value => params.append(key, value));
                }
                
                // Store active filters
                activeFilters = {
                    lead_topics: checkedFilters.lead_topic,
                    months: checkedFilters.month,
                    products: checkedFilters.product,
                    agents: checkedFilters.agent,
                    lead_outcomes: checkedFilters.lead_outcome,
                    wrap_up_reasons: checkedFilters.wrap_up_reason
                };
                
                return params;
            }

        function applyFilters() {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'none';
            initDashboard();
        }

        function clearAllFilters() {
            // Uncheck all checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
            
            // Hide all count badges
            document.querySelectorAll('.filter-count').forEach(badge => badge.style.display = 'none');
            
            // Apply filters
            applyFilters();
        }

        function removeFilter(category, value) {
            // Find and uncheck the specific checkbox
            const checkbox = document.querySelector(`[data-category="${category}"][value="${value}"]`);
            if (checkbox) {
                checkbox.checked = false;
                updateFilterCount(category);
            }
            
            // Apply filters
            applyFilters();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilterTags');
            const bar = document.getElementById('activeFiltersBar');
            container.innerHTML = '';
            
            let hasFilters = false;
            
            // Display active filters
            for (const [category, values] of Object.entries(activeFilters)) {
                values.forEach(value => {
                    hasFilters = true;
                    const label = formatFilterLabel(category, value);
                    container.innerHTML += `
                        <div class="filter-tag">
                            <span>${label}</span>
                            <span class="filter-tag-remove" onclick="removeFilter('${getCategoryKey(category)}', '${value}')">×</span>
                        </div>
                    `;
                });
            }
            
            bar.classList.toggle('show', hasFilters);
        }

        function getCategoryKey(category) {
            const map = {
                'lead_topics': 'topics',
                'months': 'months',
                'products': 'products',
                'agents': 'agents',
                'lead_outcomes': 'outcomes',
                'wrap_up_reasons': 'wrapup'
            };
            return map[category] || category;
        }

        function formatFilterLabel(category, value) {
            if (category === 'months') {
                const date = new Date(value + '-01');
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            }
            return value;
        }

// Enhanced updateStats function with tab-specific stats
        function updateStats() {
            // Get active tab
            const activeTab = document.querySelector('.nav-item.active').textContent.toLowerCase();
            
            if (!dashboardData || !dashboardData.stats) return;
            
            // Overview stats
            if (document.getElementById('stat-total-calls')) {
                document.getElementById('stat-total-calls').textContent = dashboardData.stats.total_calls;
                document.getElementById('stat-avg-sentiment').textContent = dashboardData.stats.avg_sentiment;
                document.getElementById('stat-avg-opportunity').textContent = Math.round(dashboardData.stats.avg_opportunity || 0);
                const completionRate = (dashboardData.stats.completed_transcriptions / dashboardData.stats.total_calls * 100).toFixed(1);
                document.getElementById('stat-completion-rate').textContent = completionRate + '%';
            }
            
            // Content stats
            if (document.getElementById('stat-total-questions')) {
                const questionData = dashboardData.content.question_categories || {};
                const totalQuestions = Object.values(questionData).reduce((a, b) => a + b, 0);
                document.getElementById('stat-total-questions').textContent = totalQuestions;
                
                const topQuestion = Object.entries(questionData).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('stat-top-question').textContent = topQuestion ? topQuestion[0] : '-';
                
                const topicsData = dashboardData.content.key_topics || {};
                const topTopic = Object.entries(topicsData).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('stat-top-topic').textContent = topTopic ? topTopic[0] : '-';
                document.getElementById('stat-unique-topics').textContent = Object.keys(topicsData).length;
            }
            
            // Performance stats
            if (document.getElementById('stat-objectives-yes')) {
                const objectives = dashboardData.content.objectives || {};
                document.getElementById('stat-objectives-yes').textContent = objectives['Yes'] || 0;
                document.getElementById('stat-avg-performance').textContent = Math.round(dashboardData.stats.avg_performance || 0);
                
                const tactics = dashboardData.content.sales_tactics || {};
                const topTactic = Object.entries(tactics).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('stat-top-tactic').textContent = topTactic ? topTactic[0] : '-';
                
                const total = Object.values(objectives).reduce((a, b) => a + b, 0);
                const successRate = total > 0 ? ((objectives['Yes'] || 0) / total * 100).toFixed(1) : 0;
                document.getElementById('stat-success-rate').textContent = successRate + '%';
            }
            
            // Risk stats
            if (document.getElementById('stat-high-risk')) {
                document.getElementById('stat-high-risk').textContent = dashboardData.stats.high_risk || 0;
                document.getElementById('stat-avg-risk').textContent = Math.round(dashboardData.stats.avg_risk || 0);
                
                const objections = dashboardData.content.objections || {};
                const topObjection = Object.entries(objections).sort((a, b) => b[1] - a[1])[0];
                document.getElementById('stat-top-objection').textContent = topObjection ? topObjection[0] : '-';
                
                const wrapupData = dashboardData.wrap_up_accuracy || [];
                const accurateCount = wrapupData.filter(w => w.accuracy.includes('accurate')).length;
                const accuracyRate = wrapupData.length > 0 ? (accurateCount / wrapupData.length * 100).toFixed(1) : 0;
                document.getElementById('stat-wrapup-accuracy').textContent = accuracyRate + '%';
            }
        }
        function initializeCharts() {
            // Destroy existing charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            // Check if we have data
            if (!dashboardData || !dashboardData.time_series) {
                console.error('No data available for charts');
                return;
            }

            // Time series charts
            const dates = dashboardData.time_series.dates.map(d => {
                const date = new Date(d);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            // Define pastel colors
            const pastelColors = [
                '#B8D4F1', // Soft blue
                '#D4B8F1', // Soft purple
                '#F1B8D4', // Soft pink
                '#F1D4B8', // Soft peach
                '#D4F1B8', // Soft green
                '#B8F1D4', // Soft mint
                '#FFE5CC', // Soft orange
                '#E5CCFF', // Soft lavender
                '#CCFFE5', // Soft seafoam
                '#FFCCCC', // Soft coral
            ];
            
            // Default options for all charts
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            };
            
            // Line chart specific options
            const lineChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        bottom: 10
                    }
                }
            };


            // Opportunity Chart
            if (document.getElementById('opportunityChart')) {
                charts.opportunity = new Chart(document.getElementById('opportunityChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Opportunity Score',
                            data: dashboardData.time_series.opportunity,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...lineChartOptions,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }

            // Sentiment Chart
            if (document.getElementById('sentimentChart')) {
                charts.sentiment = new Chart(document.getElementById('sentimentChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Sentiment Score',
                            data: dashboardData.time_series.sentiment,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...lineChartOptions,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }

            // Engagement Chart
            if (document.getElementById('engagementChart')) {
                charts.engagement = new Chart(document.getElementById('engagementChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Engagement Score',
                            data: dashboardData.time_series.engagement,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...lineChartOptions,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }

            // Performance Chart (also update this one)
            if (document.getElementById('performanceChart')) {
                charts.performance = new Chart(document.getElementById('performanceChart'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Performance Score',
                            data: dashboardData.time_series.performance,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...lineChartOptions,
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }

            // Questions Pie Chart
            const questionData = dashboardData.content.question_categories || {};
            if (document.getElementById('questionsChart') && Object.keys(questionData).length > 0) {
                charts.questions = new Chart(document.getElementById('questionsChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(questionData),
                        datasets: [{
                            data: Object.values(questionData),
                            backgroundColor: pastelColors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value * 100) / sum).toFixed(1);
                                    return percentage + '%';
                                },
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            }
                        },
                        layout: {
                            padding: {
                                right: 20
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Topics Chart
            const topicsData = dashboardData.content.key_topics || {};
            if (document.getElementById('topicsChart') && Object.keys(topicsData).length > 0) {
                const topTopics = Object.entries(topicsData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                
                charts.topics = new Chart(document.getElementById('topicsChart'), {
                    type: 'doughnut',
                    data: {
                        labels: topTopics.map(t => t[0]),
                        datasets: [{
                            data: topTopics.map(t => t[1]),
                            backgroundColor: pastelColors.slice(0, topTopics.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value * 100) / sum).toFixed(1);
                                    return percentage + '%';
                                },
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            }
                        },
                        layout: {
                            padding: {
                                right: 20
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Sales Tactics Chart
            const tacticsData = dashboardData.content.sales_tactics || {};
            if (document.getElementById('tacticsChart') && Object.keys(tacticsData).length > 0) {
                charts.tactics = new Chart(document.getElementById('tacticsChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(tacticsData),
                        datasets: [{
                            data: Object.values(tacticsData),
                            backgroundColor: pastelColors.slice(0, Object.keys(tacticsData).length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value * 100) / sum).toFixed(1);
                                    return percentage + '%';
                                },
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            }
                        },
                        layout: {
                            padding: {
                                right: 20
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Objectives Chart - with pastel colors
            const objectivesData = dashboardData.content.objectives || {};
            if (document.getElementById('objectivesChart') && Object.keys(objectivesData).length > 0) {
                const orderMap = { 'Yes': 0, 'Partial': 1, 'No': 2 };
                const colorMap = {
                    'Yes': '#B8F1D4',     // Pastel green
                    'Partial': '#B8D4F1',  // Pastel blue
                    'No': '#FFB8B8'       // Pastel red
                };
                
                const sortedObjectives = Object.entries(objectivesData)
                    .sort((a, b) => {
                        const orderA = orderMap[a[0]] !== undefined ? orderMap[a[0]] : 999;
                        const orderB = orderMap[b[0]] !== undefined ? orderMap[b[0]] : 999;
                        return orderA - orderB;
                    });
                
                charts.objectives = new Chart(document.getElementById('objectivesChart'), {
                    type: 'bar',
                    data: {
                        labels: sortedObjectives.map(item => item[0]),
                        datasets: [{
                            label: 'Count',
                            data: sortedObjectives.map(item => item[1]),
                            backgroundColor: sortedObjectives.map(item => colorMap[item[0]] || '#E0E0E0'),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        ...defaultOptions,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            } 
                        }
                    }
                });
            }


            // Risk Factors Chart - Horizontal bars with pastel red
            const riskData = dashboardData.content.risk_factors || {};
            if (document.getElementById('riskChart') && Object.keys(riskData).length > 0) {
                // Sort the data in descending order
                const sortedRisks = Object.entries(riskData)
                    .sort((a, b) => b[1] - a[1]);
                
                charts.risk = new Chart(document.getElementById('riskChart'), {
                    type: 'bar',
                    data: {
                        labels: sortedRisks.map(item => item[0]),
                        datasets: [{
                            label: 'Frequency',
                            data: sortedRisks.map(item => item[1]),
                            backgroundColor: '#FFB8B8',  // Pastel red
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        ...defaultOptions,
                        indexAxis: 'y',  // Horizontal bars
                        scales: { 
                            x: { 
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            } 
                        }
                    }
                });
            }

            // Objections Chart - Sort in descending order with pastel orange
            const objectionsData = dashboardData.content.objections || {};
            if (document.getElementById('objectionsChart') && Object.keys(objectionsData).length > 0) {
                // Sort the data in descending order
                const sortedObjections = Object.entries(objectionsData)
                    .sort((a, b) => b[1] - a[1]);
                
                charts.objections = new Chart(document.getElementById('objectionsChart'), {
                    type: 'bar',
                    data: {
                        labels: sortedObjections.map(item => item[0]),
                        datasets: [{
                            label: 'Count',
                            data: sortedObjections.map(item => item[1]),
                            backgroundColor: '#FFD4B8',  // Pastel orange
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        ...defaultOptions,
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            } 
                        }
                    }
                });
            }
            
            // Wrap-up Reasons Chart
            const wrapUpData = dashboardData.content.wrap_up_reasons || {};
            if (document.getElementById('wrapUpReasonsChart') && Object.keys(wrapUpData).length > 0) {
                // Sort by frequency
                const sortedWrapUp = Object.entries(wrapUpData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10); // Top 10 reasons
                
                // Store full labels for tooltip reference
                const fullLabels = sortedWrapUp.map(item => item[0]);
                const truncatedLabels = sortedWrapUp.map(item => {
                    const label = item[0];
                    return label.length > 30 ? label.substring(0, 30) + '...' : label;
                });
                
                charts.wrapUpReasons = new Chart(document.getElementById('wrapUpReasonsChart'), {
                    type: 'bar',
                    data: {
                        labels: truncatedLabels,
                        datasets: [{
                            label: 'Frequency',
                            data: sortedWrapUp.map(item => item[1]),
                            backgroundColor: '#764ba2',
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        ...defaultOptions,
                        indexAxis: 'y',  // Horizontal bars
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // Use the correct index to get the full label
                                        const index = context[0].dataIndex;
                                        return fullLabels[index];
                                    },
                                    label: function(context) {
                                        return 'Count: ' + context.parsed.x;
                                    }
                                }
                            }
                        },
                        scales: { 
                            x: { 
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            } 
                        }
                    }
                });
            }

            // Update the wrap-up accuracy percentage scorecard
            if (document.getElementById('wrapUpAccuracyRate')) {
                const accuracyRate = dashboardData.stats.wrap_up_accuracy_percentage || 0;
                document.getElementById('wrapUpAccuracyRate').textContent = accuracyRate + '%';
            }

            // Calculate and display average objection handling score
            if (document.getElementById('objectionHandlingScore')) {
                // This would need to be calculated from your data
                // For now, using a placeholder calculation
                const objectionScore = dashboardData.stats.avg_performance || 0;
                document.getElementById('objectionHandlingScore').textContent = Math.round(objectionScore);
            }

            // Populate wrap-up table
            const tbody = document.getElementById('wrapupTableBody');
            if (tbody) {
                tbody.innerHTML = '';
                if (dashboardData.wrap_up_accuracy && dashboardData.wrap_up_accuracy.length > 0) {
                    dashboardData.wrap_up_accuracy.forEach(row => {
                        const tr = document.createElement('tr');
                        
                        // Determine badge class based on accuracy value
                        let badgeClass = 'badge-gray'; // Default for "None provided"
                        let accuracyText = row.accuracy || 'None provided';
                        
                        if (accuracyText.toLowerCase().includes('completely')) {
                            badgeClass = 'badge-red';
                        } else if (accuracyText.toLowerCase().includes('somewhat')) {
                            badgeClass = 'badge-orange';
                        } else if (accuracyText.toLowerCase().includes('accurate') && !accuracyText.toLowerCase().includes('not')) {
                            badgeClass = 'badge-green';
                        } else if (accuracyText.toLowerCase().includes('none provided') || accuracyText.toLowerCase().includes('not provided')) {
                            badgeClass = 'badge-gray';
                            accuracyText = 'NONE PROVIDED'; // Standardize the display
                        }
                        
                        tr.innerHTML = `
                            <td>${row.lead_id || '-'}</td>
                            <td>${row.name}</td>
                            <td><span class="badge ${badgeClass}">${accuracyText}</span></td>
                            <td>${row.reason || 'No wrap-up reason provided to assess'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
        }

        function updateCoachAnalysis() {
            const scope = document.getElementById('coachScope').value;
            const agentContainer = document.getElementById('agentSelectContainer');
            
            if (scope === 'agent') {
                agentContainer.style.display = 'block';
            } else {
                agentContainer.style.display = 'none';
            }
        }

        function populateAgentSelect() {
            if (!dashboardData || !dashboardData.filter_options) {
                console.log('No dashboard data available for agents');
                return;
            }
            
            const select = document.getElementById('agentSelect');
            if (!select) {
                console.log('Agent select element not found');
                return;
            }
            
            select.innerHTML = '<option value="">Select an agent...</option>';
            
            dashboardData.filter_options.agents.forEach(agent => {
                select.innerHTML += `<option value="${agent}">${agent}</option>`;
            });
            
            console.log('Populated agents:', dashboardData.filter_options.agents);
        }

        async function generateCoachReport() {
            const scope = document.getElementById('coachScope').value;
            const agent = scope === 'agent' ? document.getElementById('agentSelect').value : null;
            
            if (scope === 'agent' && !agent) {
                alert('Please select an agent');
                return;
            }
            
            // Show loading
            document.getElementById('coachLoading').style.display = 'block';
            document.getElementById('coachInsights').style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:5001/api/coach-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ scope, agent })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Server error:', error);
                    throw new Error(error.error || 'Failed to generate insights');
                }
                
                const insights = await response.json();
                console.log('Received insights:', insights); // Debug log
                displayCoachInsights(insights);
                
            } catch (error) {
                console.error('Error generating coach report:', error);
                alert(`Failed to generate insights: ${error.message}`);
            } finally {
                document.getElementById('coachLoading').style.display = 'none';
            }
        }

        function displayCoachInsights(insights) {
        // Add safety checks for each property
        
        // Success Patterns
        if (insights.success_patterns && Array.isArray(insights.success_patterns)) {
            const successHtml = insights.success_patterns.map(pattern => 
                `<li>${pattern}</li>`
            ).join('');
            document.getElementById('successPatterns').innerHTML = `<ul>${successHtml}</ul>`;
        } else {
            document.getElementById('successPatterns').innerHTML = '<p>No success patterns available</p>';
        }
        
        // Failure Patterns
        if (insights.failure_patterns && Array.isArray(insights.failure_patterns)) {
            const failureHtml = insights.failure_patterns.map(pattern => 
                `<li>${pattern}</li>`
            ).join('');
            document.getElementById('failurePatterns').innerHTML = `<ul>${failureHtml}</ul>`;
        } else {
            document.getElementById('failurePatterns').innerHTML = '<p>No failure patterns available</p>';
        }
        
        // Behavioral Insights
        if (insights.behavioral_insights && Array.isArray(insights.behavioral_insights)) {
            const behavioralHtml = insights.behavioral_insights.map(insight => 
                `<li>${insight}</li>`
            ).join('');
            document.getElementById('behavioralInsights').innerHTML = `<ul>${behavioralHtml}</ul>`;
        } else {
            document.getElementById('behavioralInsights').innerHTML = '<p>No behavioral insights available</p>';
        }
        
        // Remove A/B Tests and AI Academy sections since you don't want them
        // Just hide those divs or remove them from HTML
        const abTestsEl = document.getElementById('abTests');
        if (abTestsEl && abTestsEl.parentElement) {
            abTestsEl.parentElement.style.display = 'none';
        }
        
        const aiAcademyEl = document.getElementById('aiAcademy');
        if (aiAcademyEl && aiAcademyEl.parentElement) {
            aiAcademyEl.parentElement.style.display = 'none';
        }
        
        // Objection Master
        if (insights.objection_insights && Array.isArray(insights.objection_insights) && insights.objection_insights.length > 0) {
            const objectionHtml = insights.objection_insights.map(obj => `
                <div style="margin-bottom: 15px; padding: 10px; background: #fffafa; border-radius: 6px;">
                    <strong>Objection: ${obj.objection}</strong><br>
                    <span style="color: #666;">${obj.impact}</span><br>
                    <div style="margin-top: 8px; padding: 8px; background: #f0fdf4; border-radius: 4px;">
                        <strong style="color: #10b981;">Suggested Response:</strong> ${obj.suggested_response}
                    </div>
                    ${obj.success_example ? `<div style="margin-top: 5px; font-size: 13px; color: #667eea;">✓ ${obj.success_example}</div>` : ''}
                </div>
            `).join('');
            document.getElementById('objectionMaster').innerHTML = objectionHtml;
        } else {
            document.getElementById('objectionMaster').innerHTML = '<p>No objection insights available.</p>';
        }
        
        // Show insights
        document.getElementById('coachInsights').style.display = 'block';
    }
        // Initialize on load
        window.addEventListener('load', initDashboard);
</script>
</body>
</html>
